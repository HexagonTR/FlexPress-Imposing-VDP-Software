name: Build and Release (Public Runner)

on:
  repository_dispatch:
    types: [trigger-build]

jobs:
  build-win:
    runs-on: windows-latest
    if: |
      contains(github.event.client_payload.commit_message, 'win push') || 
      contains(github.event.client_payload.commit_message, 'win mac push') || 
      (!contains(github.event.client_payload.commit_message, 'win push') && !contains(github.event.client_payload.commit_message, 'mac push'))
    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v4
        with:
          # Kendi (public) reposunu checkout eder
          path: .

      - name: Checkout Private Source Code
        uses: actions/checkout@v4
        with:
          repository: HexagonTR/FlexPress-impose-vdp
          token: ${{ secrets.GENERAL_TOKEN_REPO_WORKFLOW }}
          path: source-code

      - name: Sync Workflows and Scripts to Public Repo
        shell: bash
        run: |
          # Bu adƒ±m public repoda √ßalƒ±≈ütƒ±ƒüƒ± i√ßin √ºcretsizdir.
          # Private repodaki g√ºncel dosyalarƒ± public repoya yansƒ±tƒ±r.
          mkdir -p .github/workflows
          mkdir -p scripts
          
          cp source-code/FULL_PUBLIC_WORKFLOW_WITH_MAC.yml .github/workflows/build-and-release.yml
          cp source-code/.github/workflows/notarize-poller.yml .github/workflows/notarize-poller.yml
          cp source-code/scripts/check-notarize.js scripts/check-notarize.js
          
          git config user.name "FlexPress Automator"
          git config user.email "automator@flexpress.app"
          
          git add .github/workflows/*.yml scripts/*.js
          
          if git diff --staged --quiet; then
            echo "No workflow/script changes to sync."
          else
            echo "Syncing structural files to public repo..."
            git commit -m "Auto-sync structure from private source [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: Move Source to Root for Build
        shell: bash
        run: |
          # Kaynak kodlarƒ± build i√ßin ana dizine ta≈üƒ±yoruz
          # .git klas√∂r√ºn√º hari√ß tutuyoruz kƒ±≈ükƒ±rtmamak i√ßin
          cp -R source-code/* .
          # Gizli dosyalarƒ± da kopyala (nokta ile ba≈ülayanlar)
          cp -R source-code/.[^.]* . 2>/dev/null || true
          rm -rf source-code

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      # Bump Version in package.json using Run Number as Patch Version
      - name: Bump Version
        shell: bash
        env:
          PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
        run: |
          node -e "
            const fs = require('fs');
            try {
              const version = process.env.PAYLOAD_VERSION.replace(/^v/, '');
              const parts = version.split('.');
              // Logic: v1.0.2.52 -> 1.0.52 (Take first two segments + last segment)
              // If input is short (e.g. 1.0.52), it handles that too.
              let newVersion = version;
              if (parts.length >= 3) {
                 newVersion = parts[0] + '.' + parts[1] + '.' + parts[parts.length - 1];
              }
              
              console.log('Updating package.json to version: ' + newVersion);
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = newVersion;
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            } catch (err) {
              console.error('Failed to bump version:', err);
              process.exit(1);
            }
          "



      - name: Build Electron App (Windows)
        run: npm run electron:build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/latest.yml

  build-mac:
    runs-on: macos-latest
    if: |
      contains(github.event.client_payload.commit_message, 'mac push') || 
      contains(github.event.client_payload.commit_message, 'win mac push') || 
      (!contains(github.event.client_payload.commit_message, 'win push') && !contains(github.event.client_payload.commit_message, 'mac push'))
    env:
      # --- Centralized Build & Notarization Secrets ---
      # This isolates IDE warnings to one block at the start of the job
      PROVISIONING_PROFILE_BASE64: ${{ secrets['PROVISIONING_PROFILE_BASE64'] }}
      BUILD_CERTIFICATE_BASE64: ${{ secrets['BUILD_CERTIFICATE_BASE64'] }}
      MANUAL_APPLE_ID: ${{ secrets['APPLE_ID'] }}
      MANUAL_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets['APPLE_APP_SPECIFIC_PASSWORD'] }}
      MANUAL_APPLE_TEAM_ID: ${{ secrets['APPLE_TEAM_ID'] }}
      P12_PASSWORD: ${{ secrets['P12_PASSWORD'] }}
      GITHUB_TOKEN: ${{ secrets['GITHUB_TOKEN'] }}
      GENERAL_TOKEN_REPO_WORKFLOW: ${{ secrets['GENERAL_TOKEN_REPO_WORKFLOW'] }}
    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v4
        with:
          path: .

      - name: Checkout Private Source Code
        uses: actions/checkout@v4
        with:
          repository: HexagonTR/FlexPress-impose-vdp
          token: ${{ env.GENERAL_TOKEN_REPO_WORKFLOW }}
          path: source-code

      - name: Sync Workflows and Scripts (Internal)
        shell: bash
        run: |
          # Mac runner'da da dosyalarƒ± build √∂ncesi hazƒ±rla
          cp -R source-code/* .
          cp -R source-code/.[^.]* . 2>/dev/null || true
          rm -rf source-code

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Bump Version
        shell: bash
        env:
          PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
        run: |
          node -e "
            const fs = require('fs');
            try {
              const version = process.env.PAYLOAD_VERSION.replace(/^v/, '');
              const parts = version.split('.');
              let newVersion = version;
              if (parts.length >= 3) {
                 newVersion = parts[0] + '.' + parts[1] + '.' + parts[parts.length - 1];
              }
              console.log('Updating package.json to version: ' + newVersion);
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = newVersion;
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            } catch (err) {
              console.error('Failed to bump version:', err);
              process.exit(1);
            }
          "

      - name: Decode Signing Assets
        run: |
          echo "$PROVISIONING_PROFILE_BASE64" | base64 -D -o embedded.provisionprofile
          echo "$BUILD_CERTIFICATE_BASE64" | base64 -D -o certificate.p12

      - name: Restore Notarization ID
        uses: actions/cache/restore@v4
        with:
          path: |
            .notarization_id
            .notarization_tag
          key: notarize-id-${{ hashFiles('package.json') }}
          restore-keys: |
            notarize-id-

      - name: Build Electron App (Mac)
        run: npm run electron:build:mac
        env:
          GH_TOKEN: ${{ env.GITHUB_TOKEN }}
          MANUAL_APPLE_ID_PASSWORD: ${{ env.MANUAL_APPLE_APP_SPECIFIC_PASSWORD }}
          CSC_LINK: certificate.p12
          CSC_KEY_PASSWORD: ${{ env.P12_PASSWORD }}
          SKIP_NOTARIZE: 'true'

      - name: Submit DMG for Notarization
        shell: bash
        run: |
          DMG_PATH=$(ls dist/*.dmg | head -n 1)
          if [ -z "$DMG_PATH" ]; then
             echo "‚ùå No DMG found to notarize."
             exit 1
          fi
          echo "üöÄ Submitting $DMG_PATH for notarization..."
          node scripts/notarize.js "$DMG_PATH"
        env:
          MANUAL_APPLE_ID: ${{ env.MANUAL_APPLE_ID }}
          MANUAL_APPLE_APP_SPECIFIC_PASSWORD: ${{ env.MANUAL_APPLE_APP_SPECIFIC_PASSWORD }}
          MANUAL_APPLE_TEAM_ID: ${{ env.MANUAL_APPLE_TEAM_ID }}

      - name: Save Notarization Metadata to Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .notarization_id
            .notarization_tag
          key: notarize-id-${{ hashFiles('package.json', 'main.js') }}-${{ github.run_id }}

      - name: Prepare Notarization Meta Folder
        if: always()
        shell: bash
        run: |
          # Create a dedicated directory for artifacts to avoid dotfile issues in some environments
          mkdir -p notarization-metadata
          # Ensure files exist (either from notarize.js or touch)
          touch .notarization_id .notarization_tag
          cp .notarization_id notarization-metadata/id.txt
          cp .notarization_tag notarization-metadata/tag.txt
          echo "Metadata directory prepared."

      - name: Upload Notarization Meta for Release Job
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notarization-meta
          path: notarization-metadata/
          if-no-files-found: error
          retention-days: 1

      - name: Upload Mac Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: |
            dist/*.dmg
            dist/latest-mac.yml
            dist/*.zip

  release:
    needs: [build-win, build-mac]
    if: always() && (needs.build-win.result == 'success' || needs.build-mac.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Download Windows Artifact
        if: needs.build-win.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: release-assets

      - name: Download Mac Artifact
        if: needs.build-mac.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: mac-build
          path: release-assets

      - name: Download Notarization Metadata
        if: needs.build-mac.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: notarization-meta
          path: notarization-metadata

      - name: Restore Notarization Metadata Files
        if: needs.build-mac.result == 'success'
        shell: bash
        run: |
          if [ -d "notarization-metadata" ]; then
            cp notarization-metadata/id.txt .notarization_id
            cp notarization-metadata/tag.txt .notarization_tag
            echo "Metadata files restored from artifact."
          fi

      - name: Calculate SemVer Tag
        id: semver_tag
        shell: bash
        run: |
          CLEAN_VERSION=$(echo "${{ github.event.client_payload.version }}" | sed 's/^v//')
          RUN_NUMBER=$(echo "$CLEAN_VERSION" | awk -F. '{print $NF}')
          BASE_VERSION=$(echo "$CLEAN_VERSION" | awk -F. '{print $1"."$2}')
          NEW_VERSION="${BASE_VERSION}.${RUN_NUMBER}"
          
          echo "tag_name=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "semver=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Generate Automated Release Notes
        id: release_notes
        shell: bash
        env:
          MSG: ${{ github.event.client_payload.commit_message }}
          NOTES: ${{ github.event.client_payload.release_notes }}
        run: |
          # grep -o d√∂ng√ºs√º hata vermesin diye || true ekliyoruz
          NEW_FEATURES=$(echo "$MSG" | grep -o '\[NEW\][^\[]*' | sed 's/\[NEW\]//g' | sed 's/^ *//;s/ *$//' || true)
          FIXED_BUGS=$(echo "$MSG" | grep -o '\[FIX\][^\[]*' | sed 's/\[FIX\]//g' | sed 's/^ *//;s/ *$//' || true)
          
          FINAL_BODY=""
          
          if [ ! -z "$NEW_FEATURES" ]; then
            FINAL_BODY="${FINAL_BODY}### Yeni Fonksiyonlar\n"
            while IFS= read -r line; do
              if [ ! -z "$line" ]; then
                FINAL_BODY="${FINAL_BODY}- ${line}\n"
              fi
            done <<< "$NEW_FEATURES"
            FINAL_BODY="${FINAL_BODY}\n"
          fi
          
          if [ ! -z "$FIXED_BUGS" ]; then
            FINAL_BODY="${FINAL_BODY}### Giderilen Hatalar\n"
            while IFS= read -r line; do
              if [ ! -z "$line" ]; then
                FINAL_BODY="${FINAL_BODY}- ${line}\n"
              fi
            done <<< "$FIXED_BUGS"
            FINAL_BODY="${FINAL_BODY}\n"
          fi
          
          # Eƒüer etiket bulunamadƒ±ysa manuel notu veya varsayƒ±lanƒ± kullan
          if [ -z "$FINAL_BODY" ]; then
            FINAL_BODY="${NOTES:-'Geli≈ütirmeler ve hata d√ºzeltmeleri yapƒ±ldƒ±.'}"
          fi
          
          # GITHUB_OUTPUT i√ßin multiline desteƒüi (HEREDOC)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FINAL_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release on Public Repo (Self)
        uses: softprops/action-gh-release@v1
        with:
          # D√úZELTME: ƒ∞ki yƒ±ldƒ±z (**) ile alt klas√∂rleri de kapsar
          files: release-assets/**/*
          tag_name: ${{ steps.semver_tag.outputs.tag_name }}
          name: FlexPress ${{ steps.semver_tag.outputs.semver }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets[format('{0}{1}', 'GITHUB', '_TOKEN')] }}

      - name: Persist Tag for Poller
        shell: bash
        run: |
          echo "${{ steps.semver_tag.outputs.tag_name }}" > .notarization_tag
          echo "Saved tag for late stapling: $(cat .notarization_tag)"

      - name: Save Complete Meta to Cache for Poller
        if: always() && needs.build-mac.result == 'success'
        uses: actions/cache/save@v4
        with:
          path: |
            .notarization_id
            .notarization_tag
          key: notarize-ready-${{ github.run_id }}

      - name: Trigger Poller Immediately
        if: always() && needs.build-mac.result == 'success'
        shell: bash
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"trigger-poller"}'
