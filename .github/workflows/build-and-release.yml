name: Build and Release (Public Runner)

on:
  repository_dispatch:
    types: [trigger-build]

jobs:
  build-win:
    runs-on: windows-latest
    if: |
      contains(github.event.client_payload.commit_message, 'win push') || 
      contains(github.event.client_payload.commit_message, 'win mac push') || 
      (!contains(github.event.client_payload.commit_message, 'win push') && !contains(github.event.client_payload.commit_message, 'mac push'))
    steps:
      - name: Checkout Private Source Code
        uses: actions/checkout@v4
        with:
          repository: HexagonTR/FlexPress-impose-vdp
          token: ${{ secrets.GENERAL_TOKEN_REPO_WORKFLOW }}
          path: .

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      # Bump Version in package.json using Run Number as Patch Version
      - name: Bump Version
        shell: bash
        env:
          PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
        run: |
          node -e "
            const fs = require('fs');
            try {
              const version = process.env.PAYLOAD_VERSION.replace(/^v/, '');
              const parts = version.split('.');
              // Logic: v1.0.2.52 -> 1.0.52 (Take first two segments + last segment)
              // If input is short (e.g. 1.0.52), it handles that too.
              let newVersion = version;
              if (parts.length >= 3) {
                 newVersion = parts[0] + '.' + parts[1] + '.' + parts[parts.length - 1];
              }
              
              console.log('Updating package.json to version: ' + newVersion);
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = newVersion;
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            } catch (err) {
              console.error('Failed to bump version:', err);
              process.exit(1);
            }
          "



      - name: Build Electron App (Windows)
        run: npm run electron:build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/latest.yml

  build-mac:
    runs-on: macos-latest
    if: |
      contains(github.event.client_payload.commit_message, 'mac push') || 
      contains(github.event.client_payload.commit_message, 'win mac push') || 
      (!contains(github.event.client_payload.commit_message, 'win push') && !contains(github.event.client_payload.commit_message, 'mac push'))
    steps:
      - name: Checkout Private Source Code
        uses: actions/checkout@v4
        with:
          repository: HexagonTR/FlexPress-impose-vdp
          token: ${{ secrets.GENERAL_TOKEN_REPO_WORKFLOW }}
          path: .

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Bump Version
        shell: bash
        env:
          PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
        run: |
          node -e "
            const fs = require('fs');
            try {
              const version = process.env.PAYLOAD_VERSION.replace(/^v/, '');
              const parts = version.split('.');
              let newVersion = version;
              if (parts.length >= 3) {
                 newVersion = parts[0] + '.' + parts[1] + '.' + parts[parts.length - 1];
              }
              console.log('Updating package.json to version: ' + newVersion);
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = newVersion;
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            } catch (err) {
              console.error('Failed to bump version:', err);
              process.exit(1);
            }
          "

      - name: Decode Signing Assets
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        run: |
          echo "$PROVISIONING_PROFILE_BASE64" | base64 -D -o embedded.provisionprofile
          echo "$BUILD_CERTIFICATE_BASE64" | base64 -D -o certificate.p12

      - name: Restore Notarization ID
        uses: actions/cache/restore@v4
        with:
          path: .notarization_id
          key: notarize-id-${{ hashFiles('package.json') }}
          restore-keys: |
            notarize-id-

      - name: Build Electron App (Mac)
        run: npm run electron:build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # --- KRİTİK GİRİŞ BİLGİLERİ (TEST ETTİĞİMİZ) ---
          MANUAL_APPLE_ID: ${{ secrets.APPLE_ID }}
          MANUAL_APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MANUAL_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          MANUAL_APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # -----------------------------------------------

          CSC_LINK: certificate.p12
          CSC_KEY_PASSWORD: ${{ secrets.P12_PASSWORD }}

      - name: Save Notarization ID
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .notarization_id
          key: notarize-id-${{ hashFiles('package.json') }}

      - name: Upload Mac Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: |
            dist/*.dmg
            dist/latest-mac.yml
            dist/*.zip

  release:
    needs: [build-win, build-mac]
    if: always() && (needs.build-win.result == 'success' || needs.build-mac.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Download Windows Artifact
        if: needs.build-win.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: release-assets

      - name: Download Mac Artifact
        if: needs.build-mac.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: mac-build
          path: release-assets

      - name: Calculate SemVer Tag
        id: semver_tag
        shell: bash
        run: |
          CLEAN_VERSION=$(echo "${{ github.event.client_payload.version }}" | sed 's/^v//')
          RUN_NUMBER=$(echo "$CLEAN_VERSION" | awk -F. '{print $NF}')
          BASE_VERSION=$(echo "$CLEAN_VERSION" | awk -F. '{print $1"."$2}')
          NEW_VERSION="${BASE_VERSION}.${RUN_NUMBER}"
          
          echo "tag_name=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "semver=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Generate Automated Release Notes
        id: release_notes
        shell: bash
        run: |
          MSG="${{ github.event.client_payload.commit_message }}"
          
          # Extract [NEW] tags
          NEW_FEATURES=$(echo "$MSG" | grep -o '\[NEW\][^\[]*' | sed 's/\[NEW\]//g' | sed 's/^ *//;s/ *$//')
          
          # Extract [FIX] tags
          FIXED_BUGS=$(echo "$MSG" | grep -o '\[FIX\][^\[]*' | sed 's/\[FIX\]//g' | sed 's/^ *//;s/ *$//')
          
          BODY=""
          
          if [ ! -z "$NEW_FEATURES" ]; then
            BODY="### Yeni Fonksiyonlar\n"
            while IFS= read -r line; do
              BODY="${BODY}- ${line}\n"
            done <<< "$NEW_FEATURES"
            BODY="${BODY}\n"
          fi
          
          if [ ! -z "$FIXED_BUGS" ]; then
            BODY="${BODY}### Giderilen Hatalar\n"
            while IFS= read -r line; do
              BODY="${BODY}- ${line}\n"
            done <<< "$FIXED_BUGS"
            BODY="${BODY}\n"
          fi
          
          # If no tags found, use the original payload release notes or a default
          if [ -z "$BODY" ]; then
            BODY="${{ github.event.client_payload.release_notes || 'Geliştirmeler ve hata düzeltmeleri yapıldı.' }}"
          fi
          
          # Escape newlines for GitHub Output
          BODY="${BODY//'%'/'%25'}"
          BODY="${BODY//$'\n'/'%0A'}"
          BODY="${BODY//$'\r'/'%0D'}"
          
          echo "body=$BODY" >> $GITHUB_OUTPUT

      - name: Create Release on Public Repo (Self)
        uses: softprops/action-gh-release@v1
        with:
          # DÜZELTME: İki yıldız (**) ile alt klasörleri de kapsar
          files: release-assets/**/*
          tag_name: ${{ steps.semver_tag.outputs.tag_name }}
          name: FlexPress ${{ steps.semver_tag.outputs.semver }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
